{% from "macros/datetime.jinja" import insert_timeago with context %}
{% from "macros/links.jinja" import user_link %}


{% macro render_events_table(events) -%}
<table class="table table-events">
  <tbody>
    {% for event in events -%}
    {{ render_event_row(event) }}
    {%- endfor %}
  </tbody>
</table>
{%- endmacro %}


{% macro render_event_row(event) -%}
<tr>
  <td class="icon">
    {{ render_event_icon(event) }}
  </td>
  <td>
    <p>
      {% if event.unread %}<span class="badge badge-warning">{{ _('New') }}</span>{% endif %}
      <small>{{ insert_timeago(event.time) }}</small>
    </p>
    <p>
    {{ render_event_text(event) }}
    </p>
    <p>
    {% if event.grouped -%}
      {% for event in event.subevents -%}
        <small>{% if event.unread %}<span class="badge badge-warning badge-empty"></span>{% endif %} {{ render_event_text(event) }}</small><br/>
      {%- endfor %}
    {%- endif %}
    </p>
  </td>
  <td class="show">
    {{ _render_show_button(event_link(event)) }}
  </td>
</tr>
{%- endmacro %}


{% macro render_event_icon(event) -%}
{% if event.type == types.FLIGHT_COMMENT -%}
  <i class="icon-comments-alt"></i>
{%- elif event.type == types.FLIGHT %}
  <i class="icon-plane"></i>
{%- elif event.type == types.FOLLOWER %}
  <i class="icon-user"></i>
{%- endif %}&nbsp;
{%- endmacro %}


{% macro render_event_text(event) -%}
{% if event.grouped -%}
  {% if event.type == types.FLIGHT -%}
    {{ render_grouped_flights_event_text(event) }}
  {%- else %}
    Error: Unknown event group
  {%- endif %}
{%- else %}
  {% if event.type == types.FLIGHT_COMMENT -%}
    {{ render_flight_comment_event_text(event) }}
  {%- elif event.type == types.FLIGHT %}
    {{ render_flight_event_text(event) }}
  {%- elif event.type == types.FOLLOWER %}
    {{ render_follower_event_text(event) }}
  {%- else %}
    Error: Unknown event
  {%- endif %}
{%- endif %}
{%- endmacro %}


{% macro render_flight_comment_event_text(event) -%}
{% if current_user and (event.flight.pilot_id == current_user.id or event.flight.co_pilot_id == current_user.id) -%}
  {{ _('<strong>%(pilot)s</strong> commented on your <strong>%(distance)s</strong> flight on the <strong>%(date)s</strong>.',
       pilot=user_link(event.actor),
       distance=h.format_distance(event.flight.olc_classic_distance),
       date=h.format_date(event.flight.date_local)) }}
{%- else -%}
  {{ _('<strong>%(pilot)s</strong> commented on a <strong>%(distance)s</strong> flight on the <strong>%(date)s</strong>.',
       pilot=user_link(event.actor),
       distance=h.format_distance(event.flight.olc_classic_distance),
       date=h.format_date(event.flight.date_local)) }}
{%- endif %}
{%- endmacro %}


{% macro render_flight_event_text(event) -%}
{% trans pilot=user_link(event.actor), distance=h.format_distance(event.flight.olc_classic_distance), date=h.format_date(event.flight.date_local) -%}
<strong>{{ pilot }}</strong> uploaded a new <strong>{{ distance }}</strong> flight on the <strong>{{ date }}</strong>.
{%- endtrans %}
{%- endmacro %}


{% macro render_grouped_flights_event_text(event) -%}
{% trans pilot=user_link(event.actor), num_flights=event.subevents|count -%}
<strong>{{ pilot }}</strong> uploaded <strong>{{ num_flights }}</strong> new flights.
{%- endtrans %}
{%- endmacro %}


{% macro render_follower_event_text(event) -%}
{% if current_user and event.user_id == current_user.id -%}
  {{ _('<strong>%(pilot)s</strong> is following you now.', pilot=user_link(event.actor)) }}
{%- else -%}
  {{ _('<strong>%(pilot)s</strong> is following <strong>%(pilot2)s</strong> now.', pilot=user_link(event.actor), pilot2=user_link(event.user)) }}
{%- endif %}
{%- endmacro %}


{% macro _render_show_button(link) -%}
<a href="{{ link }}" class="btn btn-mini">{{ _('Show') }}</a>
{%- endmacro %}


{% macro event_link(event) -%}
{% if event.grouped -%}
  {% if event.type == types.FLIGHT -%}
    {{ url_for('flights.pilot', id=event.actor_id) }}
  {%- endif %}
{%- else %}
  {% if event.type == types.FLIGHT_COMMENT -%}
    {{ url_for('flight.index', flight_id=event.flight_id) }}
  {%- elif event.type == types.FLIGHT %}
    {{ url_for('flight.index', flight_id=event.flight_id) }}
  {%- elif event.type == types.FOLLOWER %}
    {{ url_for('user.index', user_id=event.user_id) }}
  {%- endif %}
{%- endif %}
{%- endmacro %}
