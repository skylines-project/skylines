name: CI

on:
  push:
    branches:
      - master
  pull_request:
  schedule:
    - cron: '0 3 * * *' # daily, at 3am

jobs:
  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    env:
      COVERAGE: true
      JOBS: 1 # See https://git.io/vdao3 for details.

      PERCY_PROJECT: skylines/skylines
      PERCY_TOKEN: 81bf0245987c87eb4924eae0b085cb60596f2f0f4d4ffe27e171828535aa6812

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - uses: volta-cli/action@v4

      - run: yarn install --frozen-lockfile
        working-directory: ./ember

      - run: npx bower install
        working-directory: ./ember

      - run: yarn lint:js
        working-directory: ./ember

      - run: yarn lint:hbs
        working-directory: ./ember

      - run: yarn ember dependency-lint
        working-directory: ./ember

      - uses: percy/exec-action@v0.3.1
        with:
          command: yarn test
          working-directory: ./ember

  embroider:
    name: Frontend (embroider)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - uses: volta-cli/action@v4

      - run: yarn install --frozen-lockfile
        working-directory: ./ember

      - run: npx bower install
        working-directory: ./ember

      - run: yarn ember build
        working-directory: ./ember
        continue-on-error: true
        env:
          USE_EMBROIDER: true

  backend:
    name: Backend
    runs-on: ubuntu-latest

    container:
      image: debian:buster-slim

    services:
      db:
        image: postgis/postgis:12-2.5
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: skylines_test
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10

    env:
      PGHOST: db
      PGUSER: postgres
      PGPASSWORD: postgres
      REDIS_URL: redis://redis:6379/0

    steps:
      - name: Install system dependencies
        run: |
          echo "deb http://archive.debian.org/debian buster main" > /etc/apt/sources.list
          echo "deb http://archive.debian.org/debian-security buster/updates main" >> /etc/apt/sources.list
          apt-get update
          apt-get install -y --no-install-recommends \
            git ca-certificates \
            python2.7 python-pip python-setuptools python-wheel python-dev \
            build-essential libpq-dev libgeos-dev libproj-dev libffi-dev libssl-dev \
            libboost-python-dev zlib1g-dev cmake \
            postgresql-client

      - uses: actions/checkout@v4

      - name: Install Python dependencies
        run: |
          pip install pipenv==2020.11.15
          pipenv lock -r --dev > /tmp/requirements-all.txt
          grep -v xcsoar /tmp/requirements-all.txt > /tmp/requirements.txt
          pip install -r /tmp/requirements.txt
          pip install xcsoar==0.7.0

      - name: Setup test database extensions
        run: |
          psql -h db -U postgres -d skylines_test -c "CREATE EXTENSION IF NOT EXISTS fuzzystrmatch;"

      - name: Run tests
        run: py.test -vv --color=yes --cov=skylines --cov-report term-missing:skip-covered

  backend-lint:
    name: Backend (Lint)
    runs-on: ubuntu-latest

    container:
      image: python:3.6-buster

    steps:
      - name: Update certificates
        run: |
          echo "deb http://archive.debian.org/debian buster main" > /etc/apt/sources.list
          echo "deb http://archive.debian.org/debian-security buster/updates main" >> /etc/apt/sources.list
          apt-get update && apt-get install -y --no-install-recommends ca-certificates

      - uses: actions/checkout@v4

      - run: pip install black==20.8b1
      - run: black config migrations skylines tests *.py --check

  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - run: docker compose -f docker-compose.yml build

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [frontend, backend, backend-lint]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: Start deployment
        uses: bobheadxi/deployments@v0.5.2
        id: deployment
        with:
          step: start
          token: ${{ secrets.GITHUB_TOKEN }}
          env: production

      - uses: actions/checkout@v4
      - uses: volta-cli/action@v4

      - run: yarn install --frozen-lockfile
        working-directory: ./ember

      - run: npx bower install
        working-directory: ./ember

      - uses: webfactory/ssh-agent@v0.5.2
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Adjust ~/.ssh/known_hosts file
        run: echo '[skylines.aero]:2222,[212.51.149.149]:2222 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEoPRdvULvcpU92D9NbU3Yan0J9DUkX5S5OnZ/V28rbZH32uWRKemIHunXpHskoPC75nmsa12uDXxtsH02epgNc=' > ~/.ssh/known_hosts

      - run: yarn ember deploy production --activate --verbose
        working-directory: ./ember
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}

      - name: Update deployment status
        uses: bobheadxi/deployments@v0.5.2
        if: always()
        with:
          step: finish
          token: ${{ secrets.GITHUB_TOKEN }}
          status: ${{ job.status }}
          env_url: https://skylines.aero/
          deployment_id: ${{ steps.deployment.outputs.deployment_id }}
