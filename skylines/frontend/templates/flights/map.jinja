{% extends "base-fullscreen.jinja" %}
{% set active_page = "flights" %}


{% from 'flights/meta-tags.jinja' import flight_meta_tags with context %}
{% from 'flights/macros.jinja' import flight_title with context %}
{% from 'flights/details-table.jinja' import render_details_table with context %}

{% block title -%}{{ flight_title(flight) }}{%- endblock %}


{%- block head %}
{{ super() }}
{{ flight_meta_tags(flight) }}
{%- endblock %}


{%- block styles %}
{{ super() }}

{% assets 'openlayers_css' -%}
<link href="{{ ASSET_URL }}" rel="stylesheet" type="text/css" />
{%- endassets %}
{%- endblock %}


{%- block scripts %}
{{ super() }}

{% assets 'openlayers_js' -%}
<script type="text/javascript" src="{{ ASSET_URL }}"></script>
{%- endassets %}

{% assets 'flot_js' -%}
<script type="text/javascript" src="{{ ASSET_URL }}"></script>
{%- endassets %}

{% assets 'flight_js' -%}
<script type="text/javascript" src="{{ ASSET_URL }}"></script>
{%- endassets %}

<script type="text/javascript">
  $(function() {
    slUnits.init({{ h.json.dumps(h.get_setting_name('distance_unit')) }},
                 {{ h.json.dumps(h.get_setting_name('speed_unit')) }},
                 {{ h.json.dumps(h.get_setting_name('lift_unit')) }},
                 {{ h.json.dumps(h.get_setting_name('altitude_unit')) }});

    initOpenLayers("map_canvas",
                   "{{ config.get('SKYLINES_MAP_TILE_URL') }}",
                   { {% if 'baselayer' in request.args %}'base_layer': '{{ request.args['baselayer'] }}',{% endif %}{% if 'overlays' in request.args %}'overlay_layers': '{{ request.args['overlays'] }}',{% endif %} });
    initFlightLayer();
    initBaro($("#barogram"));

    addFlight({{ flight.id }},
      {{ h.json.dumps(trace.encoded.points) }},
      {{ h.json.dumps(trace.encoded.levels) }},
      {{ trace.num_levels }},
      {{ h.json.dumps(trace.barogram_t) }},
      {{ h.json.dumps(trace.barogram_h) }},
      {{ h.json.dumps(trace.enl) }},
      {{ h.json.dumps(trace.zoom_levels) }},
      {{ h.json.dumps(trace.contests) }},
      {{ h.json.dumps(trace.elevations_t) }},
      {{ h.json.dumps(trace.elevations_h) }},
      { registration: {{ '"' ~ flight.registration|e ~ '"' if flight.registration else 'null' }},
        competition_id: {{ '"' ~ flight.competition_id|e ~ '"' if flight.competition_id else 'null' }} }
    );

    {% if other_flights -%}
    {% for flight, trace in other_flights if trace -%}
    addFlight({{ flight.id }},
      {{ h.json.dumps(trace.encoded.points) }},
      {{ h.json.dumps(trace.encoded.levels) }},
      {{ trace.num_levels }},
      {{ h.json.dumps(trace.barogram_t) }},
      {{ h.json.dumps(trace.barogram_h) }},
      {{ h.json.dumps(trace.enl) }},
      {{ h.json.dumps(trace.zoom_levels) }},
      {{ h.json.dumps(trace.contests) }},
      {{ h.json.dumps(trace.elevations_t) }},
      {{ h.json.dumps(trace.elevations_h) }},
      { registration: {{ '"' ~ flight.registration|e ~ '"' if flight.registration else 'null' }},
        competition_id: {{ '"' ~ flight.competition_id|e ~ '"' if flight.competition_id else 'null' }} }
    );
    {%- endfor %}
    {%- endif %}

    var factor = $("#barogram")[0].offsetHeight / map.getSize().h;
    var zoomExtent = flights.getBounds().clone().scale(1.02);
    zoomExtent.bottom -= zoomExtent.getHeight() * factor * 3/2;

    map.zoomToExtent(zoomExtent);

    hoverMap();

    var pinnedFlights = getPinnedFlights();
    for (i in pinnedFlights)
      if (pinnedFlights[i] != {{ flight.id }})
        addFlightFromJSON("/flights/" + pinnedFlights[i] + "/json");

    pinButton($("#pinned"), {{ flight.id }});

    $.getScript("https://maps.google.com/maps/api/js?v=3.7&sensor=false&callback=addGoogleLayer");
    addBingLayers("{{ config.get('SKYLINES_BING_API_KEY', 'null') }}");
    addReliefLayer();

    initInfoBox({flight_info: true, location_info: true});
  });
</script>
{%- endblock %}


{%- block content %}
<div id="map_canvas" class="olFullscreen"></div>
<div class="map-sidebar map-overlay">
<!-- Nav tabs -->
  <ul class="map-tabs" role="tablist">
    <li class="active"><a href="#summary" role="tab" data-toggle="tab">
      <i class="icon-info"></i>
    </a></li>
    <li><a href="#comments" role="tab" data-toggle="tab">
      <i class="icon-comments-alt"></i>
    </a></li>
    <li><a href="#stats" role="tab" data-toggle="tab">
      <i class="icon-bar-chart"></i>
    </a></li>
    <li><a href="#wingmen" role="tab" data-toggle="tab">
      <i class="icon-group"></i>
    </a></li>
  </ul>

  <!-- Tab panes -->
  <div class="map-tab-content">
    <div class="map-tab-pane active" id="summary">
      <div class="map-tab-header">
        <h3>Summary</h3>
      </div>

      {{ render_details_table(flight) }}
    </div>

    <div class="map-tab-pane" id="comments">
      <div class="map-tab-header">
        <h3>Comments</h3>
      </div>

      {{ comments|safe }}
    </div>

    <div class="map-tab-pane" id="stats">
      <div class="map-tab-header">
        <h3>Statistics</h3>
      </div>

      Hello World!
    </div>
    <div class="map-tab-pane" id="wingmen">
      <div class="map-tab-header">
        <h3>Wingmen</h3>
      </div>

      Hello World!
    </div>
  </div>
</div>
<div class="map-bottom-panel map-overlay">
    <div style="overflow: auto; max-height: 115px">
        <table id="fix-data" class="table table-condensed"></table>
    </div>
    <div id="barogram" style="width:100%; height:100pt;"></div>
</div>
{%- endblock %}
